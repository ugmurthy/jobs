<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Monitor Dashboard</title>
    
    <!-- Tailwind CSS and DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.24/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .job-card {
            transition: all 0.3s ease;
        }
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .progress-bar {
            transition: width 0.5s ease;
        }
        .notification {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .status-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-base-100">
    <!-- Navigation -->
    <div class="navbar bg-primary text-primary-content shadow-lg">
        <div class="navbar-start">
            <div class="dropdown">
                <div tabindex="0" role="button" class="btn btn-ghost lg:hidden">
                    <i class="fas fa-bars text-xl"></i>
                </div>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a onclick="showDashboard()" class="text-base-content">Dashboard</a></li>
                    <li><a onclick="showJobSubmission()" class="text-base-content">Submit Job</a></li>
                    <li><a onclick="showWebhooks()" class="text-base-content">Webhooks</a></li>
                </ul>
            </div>
            <a class="btn btn-ghost text-xl">
                <i class="fas fa-tasks mr-2"></i>
                Job Monitor
            </a>
        </div>
        
        <div class="navbar-center hidden lg:flex">
            <ul class="menu menu-horizontal px-1">
                <li><a onclick="showDashboard()" class="btn btn-ghost">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </a></li>
                <li><a onclick="showJobSubmission()" class="btn btn-ghost">
                    <i class="fas fa-plus mr-2"></i>Submit Job
                </a></li>
                <li><a onclick="showWebhooks()" class="btn btn-ghost">
                    <i class="fas fa-webhook mr-2"></i>Webhooks
                </a></li>
            </ul>
        </div>
        
        <div class="navbar-end">
            <div class="flex items-center gap-4">
                <!-- Connection Status -->
                <div class="flex items-center gap-2">
                    <div id="connectionStatus" class="w-3 h-3 rounded-full bg-error"></div>
                    <span id="connectionText" class="text-sm">Disconnected</span>
                </div>
                
                <!-- User Info -->
                <div id="userInfo" class="hidden flex items-center gap-2">
                    <i class="fas fa-user"></i>
                    <span id="username"></span>
                </div>
                
                <!-- Theme Toggle -->
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
                        <i class="fas fa-palette"></i>
                    </div>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a onclick="setTheme('light')" class="text-base-content">Light</a></li>
                        <li><a onclick="setTheme('dark')" class="text-base-content">Dark</a></li>
                        <li><a onclick="setTheme('cupcake')" class="text-base-content">Cupcake</a></li>
                        <li><a onclick="setTheme('cyberpunk')" class="text-base-content">Cyberpunk</a></li>
                    </ul>
                </div>
                
                <!-- Logout Button -->
                <button id="logoutBtn" onclick="logout()" class="btn btn-ghost btn-circle hidden">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Login Section -->
        <div id="loginSection" class="min-h-screen flex items-center justify-center">
            <div class="card w-96 bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title justify-center text-2xl mb-6">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Login
                    </h2>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Username</span>
                        </label>
                        <input id="loginUsername" type="text" placeholder="Enter username" class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Password</span>
                        </label>
                        <input id="loginPassword" type="password" placeholder="Enter password" class="input input-bordered" />
                    </div>
                    
                    <div class="form-control mt-6">
                        <button onclick="login()" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            Login
                        </button>
                    </div>
                    
                    <div class="divider">OR</div>
                    
                    <div class="form-control">
                        <button onclick="showRegister()" class="btn btn-outline">
                            <i class="fas fa-user-plus mr-2"></i>
                            Register New Account
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Section -->
        <div id="registerSection" class="min-h-screen flex items-center justify-center hidden">
            <div class="card w-96 bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title justify-center text-2xl mb-6">
                        <i class="fas fa-user-plus mr-2"></i>
                        Register
                    </h2>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Username</span>
                        </label>
                        <input id="registerUsername" type="text" placeholder="Choose username" class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Password</span>
                        </label>
                        <input id="registerPassword" type="password" placeholder="Choose password" class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Email (optional)</span>
                        </label>
                        <input id="registerEmail" type="email" placeholder="Enter email" class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Webhook URL (optional)</span>
                        </label>
                        <input id="registerWebhook" type="url" placeholder="https://your-webhook-url.com" class="input input-bordered" />
                    </div>
                    
                    <div class="form-control mt-6">
                        <button onclick="register()" class="btn btn-primary">
                            <i class="fas fa-user-plus mr-2"></i>
                            Register
                        </button>
                    </div>
                    
                    <div class="form-control mt-2">
                        <button onclick="showLogin()" class="btn btn-ghost">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back to Login
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="hidden">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="stat bg-base-100 shadow rounded-lg">
                    <div class="stat-figure text-primary">
                        <i class="fas fa-tasks text-3xl"></i>
                    </div>
                    <div class="stat-title">Total Jobs</div>
                    <div class="stat-value text-primary" id="totalJobs">0</div>
                </div>
                
                <div class="stat bg-base-100 shadow rounded-lg">
                    <div class="stat-figure text-success">
                        <i class="fas fa-check-circle text-3xl"></i>
                    </div>
                    <div class="stat-title">Completed</div>
                    <div class="stat-value text-success" id="completedJobs">0</div>
                </div>
                
                <div class="stat bg-base-100 shadow rounded-lg">
                    <div class="stat-figure text-warning">
                        <i class="fas fa-clock text-3xl"></i>
                    </div>
                    <div class="stat-title">Running</div>
                    <div class="stat-value text-warning" id="runningJobs">0</div>
                </div>
                
                <div class="stat bg-base-100 shadow rounded-lg">
                    <div class="stat-figure text-error">
                        <i class="fas fa-exclamation-triangle text-3xl"></i>
                    </div>
                    <div class="stat-title">Failed</div>
                    <div class="stat-value text-error" id="failedJobs">0</div>
                </div>
            </div>

            <!-- Jobs List -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="card-title">
                            <i class="fas fa-list mr-2"></i>
                            Recent Jobs
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="refreshJobs()" class="btn btn-sm btn-outline">
                                <i class="fas fa-refresh mr-2"></i>
                                Refresh
                            </button>
                            <button onclick="loadAllJobs()" class="btn btn-sm btn-primary">
                                <i class="fas fa-eye mr-2"></i>
                                View All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="statusFilter" class="select select-bordered select-sm" onchange="filterJobs()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="waiting">Waiting</option>
                            <option value="delayed">Delayed</option>
                        </select>
                        
                        <input id="searchJobs" type="text" placeholder="Search jobs..." class="input input-bordered input-sm" oninput="filterJobs()" />
                    </div>
                    
                    <div id="jobsList" class="space-y-4">
                        <!-- Jobs will be populated here -->
                    </div>
                    
                    <!-- Pagination -->
                    <div id="pagination" class="flex justify-center mt-6">
                        <!-- Pagination controls will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Submission Section -->
        <div id="jobSubmissionSection" class="hidden">
            <div class="card bg-base-100 shadow-xl max-w-2xl mx-auto">
                <div class="card-body">
                    <h2 class="card-title justify-center text-2xl mb-6">
                        <i class="fas fa-plus mr-2"></i>
                        Submit New Job
                    </h2>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Job Name</span>
                        </label>
                        <input id="jobName" type="text" placeholder="Enter job name" class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Job Data (JSON)</span>
                        </label>
                        <textarea id="jobData" class="textarea textarea-bordered h-32" placeholder='{"key": "value", "message": "Hello World"}'></textarea>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Job Options (JSON, optional)</span>
                        </label>
                        <textarea id="jobOptions" class="textarea textarea-bordered h-24" placeholder='{"removeOnComplete": {"count": 5}}'></textarea>
                    </div>
                    
                    <div class="form-control mt-6">
                        <button onclick="submitJob()" class="btn btn-primary">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Submit Job
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Webhooks Section -->
        <div id="webhooksSection" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Add Webhook -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">
                            <i class="fas fa-plus mr-2"></i>
                            Add Webhook
                        </h2>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Webhook URL</span>
                            </label>
                            <input id="webhookUrl" type="url" placeholder="https://your-webhook-url.com" class="input input-bordered" />
                        </div>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Event Type</span>
                            </label>
                            <select id="webhookEventType" class="select select-bordered">
                                <option value="all">All Events</option>
                                <option value="progress">Progress Updates</option>
                                <option value="completed">Job Completion</option>
                                <option value="failed">Job Failures</option>
                                <option value="delta">Delta Updates</option>
                            </select>
                        </div>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Description</span>
                            </label>
                            <input id="webhookDescription" type="text" placeholder="Webhook description" class="input input-bordered" />
                        </div>
                        
                        <div class="form-control mt-4">
                            <button onclick="addWebhook()" class="btn btn-primary">
                                <i class="fas fa-plus mr-2"></i>
                                Add Webhook
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Webhooks List -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="card-title">
                                <i class="fas fa-list mr-2"></i>
                                Your Webhooks
                            </h2>
                            <button onclick="loadWebhooks()" class="btn btn-sm btn-outline">
                                <i class="fas fa-refresh mr-2"></i>
                                Refresh
                            </button>
                        </div>
                        
                        <div id="webhooksList" class="space-y-3">
                            <!-- Webhooks will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast toast-end z-50">
        <!-- Notifications will be added here -->
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-box">
            <div class="flex items-center justify-center">
                <span class="loading loading-spinner loading-lg mr-4"></span>
                <span id="loadingText">Loading...</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket = null;
        let authToken = localStorage.getItem('authToken');
        let refreshToken = localStorage.getItem('refreshToken');
        let currentUser = null;
        let jobs = [];
        let webhooks = [];
        let currentPage = 1;
        let totalPages = 1;
        const API_BASE = 'http://localhost:4000';
        let deltaContentAccumulator = {}; // Object to accumulate delta content by jobId

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                initializeApp();
            } else {
                showLogin();
            }
        });

        // Authentication Functions
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showNotification('Please enter username and password', 'error');
                return;
            }

            showLoading('Logging in...');

            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.accessToken;
                    refreshToken = data.refreshToken;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    localStorage.setItem('username', username);
                    
                    currentUser = { username };
                    initializeApp();
                    showNotification('Login successful!', 'success');
                } else {
                    showNotification(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
                console.error('Login error:', error);
            } finally {
                hideLoading();
            }
        }

        async function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const email = document.getElementById('registerEmail').value;
            const webhookUrl = document.getElementById('registerWebhook').value;

            if (!username || !password) {
                showNotification('Please enter username and password', 'error');
                return;
            }

            showLoading('Creating account...');

            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, email, webhookUrl })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.accessToken;
                    refreshToken = data.refreshToken;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    localStorage.setItem('username', username);
                    
                    currentUser = { username };
                    initializeApp();
                    showNotification('Registration successful!', 'success');
                } else {
                    showNotification(data.message || 'Registration failed', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
                console.error('Registration error:', error);
            } finally {
                hideLoading();
            }
        }

        function logout() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            authToken = null;
            refreshToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('username');
            
            // Clear login form fields
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            // Clear register form fields for security
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerWebhook').value = '';
            
            showLogin();
            updateConnectionStatus(false);
            showNotification('Logged out successfully', 'info');
        }

        // App Initialization
        function initializeApp() {
            currentUser = { username: localStorage.getItem('username') };
            document.getElementById('username').textContent = currentUser.username;
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            
            connectSocket();
            showDashboard();
            loadJobs();
        }

        // Socket.IO Functions
        function connectSocket() {
            if (socket) {
                socket.disconnect();
            }

            socket = io(API_BASE, {
                auth: {
                    token: authToken
                }
            });

            socket.on('connect', () => {
                console.log('Connected to server');
                updateConnectionStatus(true);
                showNotification('Connected to real-time updates', 'success');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateConnectionStatus(false);
                showNotification('Disconnected from real-time updates', 'warning');
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                updateConnectionStatus(false);
                showNotification('Connection error: ' + error.message, 'error');
            });

            // Job event listeners
            socket.on('job:progress', (data) => {
                console.log('Job progress:', data);
                updateJobInList(data.jobId, { progress: data.progress, state: 'active' });
                
                // Check if this is a delta event
                if (data.progress && data.progress.event === 'delta') {
                    // Accumulate delta content instead of showing notification
                    if (data.progress.content && data.progress.content.content) {
                        accumulateDeltaContent(data.jobId, data.jobName, data.progress.content.content);
                    }
                } else {
                    // For non-delta progress events, show notification as usual
                    showNotification(`Job ${data.jobName} progress: ${data.progress}%`, 'info');
                }
            });

            socket.on('job:completed', (data) => {
                console.log('Job completed:', data);
                updateJobInList(data.jobId, { state: 'completed', result: data.result });
                showNotification(`Job ${data.jobName} completed!`, 'success');
                updateStats();
                
                // Update the delta modal if it exists to show completion status
                if (deltaContentAccumulator[data.jobId] && deltaContentAccumulator[data.jobId].modalOpen) {
                    const modal = document.getElementById(`delta-modal-${data.jobId}`);
                    if (modal) {
                        const titleElement = modal.querySelector('h3');
                        if (titleElement) {
                            titleElement.innerHTML = `
                                <i class="fas fa-check-circle text-success mr-2"></i>
                                Job Output: ${data.jobName} <span class="badge badge-success ml-2">Completed</span>
                            `;
                        }
                        
                        const labelElement = modal.querySelector('.label-text-alt');
                        if (labelElement) {
                            labelElement.textContent = 'Job completed';
                            labelElement.className = 'label-text-alt text-success';
                        }
                    }
                }
            });

            socket.on('job:failed', (data) => {
                console.log('Job failed:', data);
                updateJobInList(data.jobId, { state: 'failed', error: data.error });
                showNotification(`Job ${data.jobName} failed: ${data.error}`, 'error');
                updateStats();
                
                // Update the delta modal if it exists to show failure status
                if (deltaContentAccumulator[data.jobId] && deltaContentAccumulator[data.jobId].modalOpen) {
                    const modal = document.getElementById(`delta-modal-${data.jobId}`);
                    if (modal) {
                        const titleElement = modal.querySelector('h3');
                        if (titleElement) {
                            titleElement.innerHTML = `
                                <i class="fas fa-exclamation-circle text-error mr-2"></i>
                                Job Output: ${data.jobName} <span class="badge badge-error ml-2">Failed</span>
                            `;
                        }
                        
                        const labelElement = modal.querySelector('.label-text-alt');
                        if (labelElement) {
                            labelElement.textContent = `Job failed: ${data.error}`;
                            labelElement.className = 'label-text-alt text-error';
                        }
                        
                        // Add error message to the modal
                        const contentContainer = modal.querySelector('.space-y-4');
                        if (contentContainer) {
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'alert alert-error mt-4';
                            errorDiv.innerHTML = `
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <span>${data.error}</span>
                            `;
                            contentContainer.appendChild(errorDiv);
                        }
                    }
                }
            });

            // Add listener for delta events
            socket.on('job:delta', (data) => {
                console.log('Job delta event:', data);
                
                // Handle the content appropriately without showing notification
                if (data.content) {
                    // Accumulate delta content
                    accumulateDeltaContent(data.jobId, data.jobName, data.content);
                    
                    // Also update the job delta in UI for consistency
                    updateJobDeltaInUI(data.jobId, data.content);
                }
            });
        }

        // Job Management Functions
        async function submitJob() {
            const name = document.getElementById('jobName').value;
            const dataText = document.getElementById('jobData').value;
            const optionsText = document.getElementById('jobOptions').value;

            if (!name || !dataText) {
                showNotification('Please enter job name and data', 'error');
                return;
            }

            let jobData, jobOptions;
            try {
                jobData = JSON.parse(dataText);
                jobOptions = optionsText ? JSON.parse(optionsText) : undefined;
            } catch (error) {
                showNotification('Invalid JSON format', 'error');
                return;
            }

            showLoading('Submitting job...');

            try {
                const response = await fetch(`${API_BASE}/submit-job`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        data: jobData,
                        options: jobOptions
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(`Job submitted successfully! ID: ${result.jobId}`, 'success');
                    
                    // Subscribe to job updates
                    if (socket) {
                        socket.emit('subscribe:job', result.jobId);
                    }
                    
                    // Clear form
                    document.getElementById('jobName').value = '';
                    document.getElementById('jobData').value = '';
                    document.getElementById('jobOptions').value = '';
                    
                    // Refresh jobs list
                    setTimeout(() => loadJobs(), 1000);
                } else {
                    showNotification(result.message || 'Job submission failed', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
                console.error('Job submission error:', error);
            } finally {
                hideLoading();
            }
        }

        async function loadJobs(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/jobs?page=${page}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    jobs = data.jobs;
                    currentPage = data.pagination.page;
                    totalPages = data.pagination.pages;
                    
                    renderJobs();
                    renderPagination();
                    updateStats();
                } else {
                    showNotification('Failed to load jobs', 'error');
                }
            } catch (error) {
                showNotification('Network error while loading jobs', 'error');
                console.error('Load jobs error:', error);
            }
        }

        async function loadAllJobs() {
            try {
                const response = await fetch(`${API_BASE}/jobs?limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    jobs = data.jobs;
                    renderJobs();
                    updateStats();
                    showNotification(`Loaded ${jobs.length} jobs`, 'info');
                } else {
                    showNotification('Failed to load all jobs', 'error');
                }
            } catch (error) {
                showNotification('Network error while loading jobs', 'error');
                console.error('Load all jobs error:', error);
            }
        }

        function renderJobs() {
            const jobsList = document.getElementById('jobsList');
            
            if (jobs.length === 0) {
                jobsList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-4xl text-base-300 mb-4"></i>
                        <p class="text-base-content/60">No jobs found</p>
                    </div>
                `;
                return;
            }

            // Sort jobs by created timestamp - recent jobs on top
            const sortedJobs = [...jobs].sort((a, b) => {
                return new Date(b.timestamp.created) - new Date(a.timestamp.created);
            });

            jobsList.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>Job Name</th>
                                <th>Job ID</th>
                                <th>Created</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedJobs.map(job => `
                                <tr class="hover">
                                    <td class="font-medium">${job.name}</td>
                                    <td class="font-mono text-sm">${job.id}</td>
                                    <td class="text-sm">${formatDate(job.timestamp.created)}</td>
                                    <td class="font-mono text-sm">${calculateDuration(job)}</td>
                                    <td>${getStatusBadge(job.state)}</td>
                                    <td>
                                        <button onclick="viewJobDetails('${job.id}')" class="btn btn-sm btn-ghost">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '<div class="join">';
            
            // Previous button
            paginationHTML += `
                <button class="join-item btn ${currentPage === 1 ? 'btn-disabled' : ''}" 
                        onclick="loadJobs(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="join-item btn btn-active">${i}</button>`;
                } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<button class="join-item btn" onclick="loadJobs(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += `<button class="join-item btn btn-disabled">...</button>`;
                }
            }
            
            // Next button
            paginationHTML += `
                <button class="join-item btn ${currentPage === totalPages ? 'btn-disabled' : ''}"
                        onclick="loadJobs(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationHTML += '</div>';
            pagination.innerHTML = paginationHTML;
        }

        function updateStats() {
            const total = jobs.length;
            const completed = jobs.filter(job => job.state === 'completed').length;
            const running = jobs.filter(job => job.state === 'active').length;
            const failed = jobs.filter(job => job.state === 'failed').length;
            
            document.getElementById('totalJobs').textContent = total;
            document.getElementById('completedJobs').textContent = completed;
            document.getElementById('runningJobs').textContent = running;
            document.getElementById('failedJobs').textContent = failed;
        }

        function updateJobInList(jobId, updates) {
            const jobIndex = jobs.findIndex(job => job.id === jobId);
            if (jobIndex !== -1) {
                jobs[jobIndex] = { ...jobs[jobIndex], ...updates };
                renderJobs();
                updateStats();
            }
        }

        function getStatusBadge(state) {
            const badges = {
                'active': '<span class="badge badge-warning">Active</span>',
                'completed': '<span class="badge badge-success">Completed</span>',
                'failed': '<span class="badge badge-error">Failed</span>',
                'waiting': '<span class="badge badge-info">Waiting</span>',
                'delayed': '<span class="badge badge-secondary">Delayed</span>'
            };
            return badges[state] || '<span class="badge badge-ghost">Unknown</span>';
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        function calculateDuration(job) {
            const startTime = job.timestamp.started || job.timestamp.created;
            const endTime = job.timestamp.finished || (job.state === 'active' ? Date.now() : null);
            
            if (!endTime) return '--:--';
            
            const durationMs = endTime - new Date(startTime).getTime();
            const minutes = Math.floor(durationMs / 60000);
            const seconds = Math.floor((durationMs % 60000) / 1000);
            
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function refreshJobs() {
            loadJobs(currentPage);
        }

        function filterJobs() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchJobs').value.toLowerCase();
            
            // This is a simple client-side filter
            // In a real app, you'd want to do this server-side
            let filteredJobs = jobs;
            
            if (statusFilter) {
                filteredJobs = filteredJobs.filter(job => job.state === statusFilter);
            }
            
            if (searchTerm) {
                filteredJobs = filteredJobs.filter(job =>
                    job.name.toLowerCase().includes(searchTerm) ||
                    job.id.toString().includes(searchTerm)
                );
            }
            
            // Temporarily replace jobs array for rendering
            const originalJobs = jobs;
            jobs = filteredJobs;
            renderJobs();
            jobs = originalJobs;
        }

        async function viewJobDetails(jobId) {
            try {
                const response = await fetch(`${API_BASE}/jobs/${jobId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const job = await response.json();
                    showJobDetailsModal(job);
                } else {
                    showNotification('Failed to load job details', 'error');
                }
            } catch (error) {
                showNotification('Network error while loading job details', 'error');
                console.error('Job details error:', error);
            }
        }

        function showJobDetailsModal(job) {
            const modal = document.createElement('div');
            modal.className = 'modal modal-open';
            modal.setAttribute('data-job-id', job.id);
            modal.innerHTML = `
                <div class="modal-box max-w-2xl">
                    <h3 class="font-bold text-lg mb-4">Job Details</h3>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label">
                                    <span class="label-text font-semibold">Job ID</span>
                                </label>
                                <input type="text" value="${job.id}" class="input input-bordered w-full" readonly />
                            </div>
                            <div>
                                <label class="label">
                                    <span class="label-text font-semibold">Job Name</span>
                                </label>
                                <input type="text" value="${job.name}" class="input input-bordered w-full" readonly />
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label">
                                    <span class="label-text font-semibold">Status</span>
                                </label>
                                <div class="p-3 border rounded-lg">
                                    ${getStatusBadge(job.state)}
                                </div>
                            </div>
                            <div>
                                <label class="label">
                                    <span class="label-text font-semibold">Progress</span>
                                </label>
                                <div class="p-3 border rounded-lg">
                                    <progress class="progress progress-primary w-full" value="${job.progress || 0}" max="100"></progress>
                                    <span class="text-sm">${job.progress || 0}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="label">
                                <span class="label-text font-semibold">Timestamps</span>
                            </label>
                            <div class="bg-base-200 p-3 rounded-lg space-y-1 text-sm">
                                <p><strong>Created:</strong> ${formatDate(job.timestamp.created)}</p>
                                ${job.timestamp.started ? `<p><strong>Started:</strong> ${formatDate(job.timestamp.started)}</p>` : ''}
                                ${job.timestamp.finished ? `<p><strong>Finished:</strong> ${formatDate(job.timestamp.finished)}</p>` : ''}
                            </div>
                        </div>
                        
                        ${job.result ? `
                            <div>
                                <label class="label">
                                    <span class="label-text font-semibold">Result</span>
                                </label>
                                <textarea class="textarea textarea-bordered w-full h-32" readonly>${JSON.stringify(job.result, null, 2)}</textarea>
                            </div>
                        ` : ''}
                        
                        ${job.failedReason ? `
                            <div>
                                <label class="label">
                                    <span class="label-text font-semibold">Error</span>
                                </label>
                                <div class="alert alert-error">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>${job.failedReason}</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${job.deltaUpdates && job.deltaUpdates.length > 0 ? `
                            <div class="delta-updates">
                                <label class="label">
                                    <span class="label-text font-semibold">Delta Updates</span>
                                </label>
                                <div class="bg-base-200 p-3 rounded-lg space-y-2 text-sm">
                                    ${job.deltaUpdates.map(update => `
                                        <div class="p-2 bg-base-100 rounded border">
                                            <div class="text-xs text-base-content/70 mb-1">
                                                ${new Date(update.timestamp).toLocaleString()}
                                            </div>
                                            <div class="font-mono text-sm">
                                                ${typeof update.content === 'object' ?
                                                    JSON.stringify(update.content, null, 2) :
                                                    update.content.toString()}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="modal-action">
                        <button class="btn" onclick="this.closest('.modal').remove()">Close</button>
                        <button class="btn btn-primary" onclick="subscribeToJob('${job.id}')">
                            <i class="fas fa-bell mr-2"></i>
                            Subscribe to Updates
                        </button>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="this.closest('.modal').remove()"></div>
            `;
            
            document.body.appendChild(modal);
        }

        function subscribeToJob(jobId) {
            if (socket) {
                socket.emit('subscribe:job', jobId);
                showNotification(`Subscribed to job ${jobId} updates`, 'success');
            } else {
                showNotification('Not connected to real-time updates', 'error');
            }
        }

        // Function to update job delta information in the UI
        function updateJobDeltaInUI(jobId, content) {
            // Store delta updates in the job object
            const jobIndex = jobs.findIndex(job => job.id === jobId);
            if (jobIndex !== -1) {
                // Initialize deltaUpdates array if it doesn't exist
                if (!jobs[jobIndex].deltaUpdates) {
                    jobs[jobIndex].deltaUpdates = [];
                }
                
                // Add the new delta update with timestamp
                jobs[jobIndex].deltaUpdates.push({
                    content: content,
                    timestamp: new Date()
                });
                
                // If the job details modal is currently open for this job, update it
                const openModal = document.querySelector('.modal');
                if (openModal && openModal.querySelector(`[data-job-id="${jobId}"]`)) {
                    // Update the delta updates section in the modal
                    const deltaSection = openModal.querySelector('.delta-updates');
                    if (deltaSection) {
                        renderDeltaUpdates(deltaSection, jobs[jobIndex].deltaUpdates);
                    } else {
                        // Create delta updates section if it doesn't exist
                        const modalContent = openModal.querySelector('.modal-box > .space-y-4');
                        if (modalContent) {
                            const newDeltaSection = document.createElement('div');
                            newDeltaSection.className = 'delta-updates';
                            
                            const label = document.createElement('label');
                            label.className = 'label';
                            label.innerHTML = '<span class="label-text font-semibold">Delta Updates</span>';
                            
                            newDeltaSection.appendChild(label);
                            modalContent.appendChild(newDeltaSection);
                            
                            renderDeltaUpdates(newDeltaSection, jobs[jobIndex].deltaUpdates);
                        }
                    }
                }
            }
        }
        
        // Helper function to render delta updates
        function renderDeltaUpdates(container, updates) {
            const updatesContainer = document.createElement('div');
            updatesContainer.className = 'bg-base-200 p-3 rounded-lg space-y-2 text-sm';
            
            if (updates.length === 0) {
                updatesContainer.innerHTML = '<p class="text-base-content/60">No delta updates</p>';
            } else {
                updates.forEach(update => {
                    const updateElement = document.createElement('div');
                    updateElement.className = 'p-2 bg-base-100 rounded border';
                    
                    // Format timestamp
                    const timestamp = document.createElement('div');
                    timestamp.className = 'text-xs text-base-content/70 mb-1';
                    timestamp.textContent = new Date(update.timestamp).toLocaleString();
                    
                    // Format content
                    const content = document.createElement('div');
                    content.className = 'font-mono text-sm';
                    content.textContent = typeof update.content === 'object' ?
                        JSON.stringify(update.content, null, 2) : update.content.toString();
                    
                    updateElement.appendChild(timestamp);
                    updateElement.appendChild(content);
                    updatesContainer.appendChild(updateElement);
                });
            }
            
            // Clear and update the container
            container.innerHTML = '';
            if (container.querySelector('label')) {
                container.appendChild(container.querySelector('label'));
            }
            container.appendChild(updatesContainer);
        }
        
        // Function to accumulate delta content
        function accumulateDeltaContent(jobId, jobName, content) {
            // Initialize if not exists
            if (!deltaContentAccumulator[jobId]) {
                deltaContentAccumulator[jobId] = {
                    jobName: jobName,
                    content: '',
                    updates: [],
                    modalOpen: false
                };
                
                // Show the modal immediately on first delta event
                showDeltaContentModal(jobId, jobName);
                deltaContentAccumulator[jobId].modalOpen = true;
            }
            
            // Add the new content
            deltaContentAccumulator[jobId].content += content;
            
            // Also store individual updates with timestamps for detailed view
            deltaContentAccumulator[jobId].updates.push({
                content: content,
                timestamp: new Date()
            });
            
            // Update the job object as well for consistency
            const jobIndex = jobs.findIndex(job => job.id === jobId);
            if (jobIndex !== -1) {
                if (!jobs[jobIndex].deltaUpdates) {
                    jobs[jobIndex].deltaUpdates = [];
                }
                jobs[jobIndex].deltaUpdates.push({
                    content: content,
                    timestamp: new Date()
                });
            }
            
            // Update the modal content if it's open
            if (deltaContentAccumulator[jobId].modalOpen) {
                updateDeltaContentModal(jobId);
            }
        }
        
        // Function to show accumulated delta content in a modal
        function showDeltaContentModal(jobId, jobName) {
            if (!deltaContentAccumulator[jobId]) return;
            
            // Check if modal already exists
            const existingModal = document.querySelector(`.modal[data-delta-job-id="${jobId}"]`);
            if (existingModal) {
                // Modal already exists, just update it
                updateDeltaContentModal(jobId);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal modal-open';
            modal.setAttribute('data-job-id', jobId);
            modal.setAttribute('data-delta-job-id', jobId); // Special attribute for delta modals
            modal.id = `delta-modal-${jobId}`;
            modal.innerHTML = `
                <div class="modal-box max-w-2xl">
                    <h3 class="font-bold text-lg mb-4">
                        <i class="fas fa-file-alt mr-2"></i>
                        Job Output: ${jobName}
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="label">
                                <span class="label-text font-semibold">Live Output</span>
                                <span class="label-text-alt text-success">Updating in real-time</span>
                            </label>
                            <div class="bg-base-200 p-3 rounded-lg">
                                <pre id="delta-content-${jobId}" class="whitespace-pre-wrap font-mono text-sm overflow-auto max-h-96">${deltaContentAccumulator[jobId].content}</pre>
                            </div>
                        </div>
                        
                        <div class="collapse collapse-arrow">
                            <input type="checkbox" />
                            <div class="collapse-title font-medium">
                                <span id="delta-updates-count-${jobId}">View Individual Updates (${deltaContentAccumulator[jobId].updates.length})</span>
                            </div>
                            <div class="collapse-content">
                                <div id="delta-updates-${jobId}" class="bg-base-200 p-3 rounded-lg space-y-2 text-sm">
                                    ${deltaContentAccumulator[jobId].updates.map(update => `
                                        <div class="p-2 bg-base-100 rounded border">
                                            <div class="text-xs text-base-content/70 mb-1">
                                                ${new Date(update.timestamp).toLocaleString()}
                                            </div>
                                            <div class="font-mono text-sm">
                                                ${update.content}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-action">
                        <button class="btn" onclick="closeDeltaModal('${jobId}')">Close</button>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeDeltaModal('${jobId}')"></div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Function to update the delta content modal
        function updateDeltaContentModal(jobId) {
            if (!deltaContentAccumulator[jobId]) return;
            
            const contentElement = document.getElementById(`delta-content-${jobId}`);
            if (contentElement) {
                contentElement.textContent = deltaContentAccumulator[jobId].content;
            }
            
            const updatesCountElement = document.getElementById(`delta-updates-count-${jobId}`);
            if (updatesCountElement) {
                updatesCountElement.textContent = `View Individual Updates (${deltaContentAccumulator[jobId].updates.length})`;
            }
            
            const updatesElement = document.getElementById(`delta-updates-${jobId}`);
            if (updatesElement) {
                updatesElement.innerHTML = deltaContentAccumulator[jobId].updates.map(update => `
                    <div class="p-2 bg-base-100 rounded border">
                        <div class="text-xs text-base-content/70 mb-1">
                            ${new Date(update.timestamp).toLocaleString()}
                        </div>
                        <div class="font-mono text-sm">
                            ${update.content}
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // Function to close delta modal
        function closeDeltaModal(jobId) {
            const modal = document.getElementById(`delta-modal-${jobId}`);
            if (modal) {
                modal.remove();
                if (deltaContentAccumulator[jobId]) {
                    deltaContentAccumulator[jobId].modalOpen = false;
                }
            }
        }

        // Webhook Management Functions
        async function loadWebhooks() {
            try {
                const response = await fetch(`${API_BASE}/webhooks`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    webhooks = data.webhooks;
                    renderWebhooks();
                } else {
                    showNotification('Failed to load webhooks', 'error');
                }
            } catch (error) {
                showNotification('Network error while loading webhooks', 'error');
                console.error('Load webhooks error:', error);
            }
        }

        async function addWebhook() {
            const url = document.getElementById('webhookUrl').value;
            const eventType = document.getElementById('webhookEventType').value;
            const description = document.getElementById('webhookDescription').value;

            if (!url) {
                showNotification('Please enter a webhook URL', 'error');
                return;
            }

            showLoading('Adding webhook...');

            try {
                const response = await fetch(`${API_BASE}/webhooks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ url, eventType, description })
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification('Webhook added successfully!', 'success');
                    
                    // Clear form
                    document.getElementById('webhookUrl').value = '';
                    document.getElementById('webhookDescription').value = '';
                    
                    // Refresh webhooks list
                    loadWebhooks();
                } else {
                    showNotification(data.message || 'Failed to add webhook', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
                console.error('Add webhook error:', error);
            } finally {
                hideLoading();
            }
        }

        async function deleteWebhook(webhookId) {
            if (!confirm('Are you sure you want to delete this webhook?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/webhooks/${webhookId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    showNotification('Webhook deleted successfully!', 'success');
                    loadWebhooks();
                } else {
                    showNotification('Failed to delete webhook', 'error');
                }
            } catch (error) {
                showNotification('Network error while deleting webhook', 'error');
                console.error('Delete webhook error:', error);
            }
        }

        function renderWebhooks() {
            const webhooksList = document.getElementById('webhooksList');
            
            if (webhooks.length === 0) {
                webhooksList.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-webhook text-2xl text-base-300 mb-2"></i>
                        <p class="text-base-content/60">No webhooks configured</p>
                    </div>
                `;
                return;
            }

            webhooksList.innerHTML = webhooks.map(webhook => `
                <div class="card bg-base-200 p-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="badge badge-sm ${webhook.active ? 'badge-success' : 'badge-error'}">
                                    ${webhook.active ? 'Active' : 'Inactive'}
                                </span>
                                <span class="badge badge-sm badge-outline">${webhook.eventType}</span>
                            </div>
                            <p class="text-sm font-medium truncate">${webhook.url}</p>
                            ${webhook.description ? `<p class="text-xs text-base-content/60">${webhook.description}</p>` : ''}
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editWebhook(${webhook.id})" class="btn btn-xs btn-ghost">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteWebhook(${webhook.id})" class="btn btn-xs btn-ghost text-error">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editWebhook(webhookId) {
            const webhook = webhooks.find(w => w.id === webhookId);
            if (!webhook) return;

            const modal = document.createElement('div');
            modal.className = 'modal modal-open';
            modal.innerHTML = `
                <div class="modal-box">
                    <h3 class="font-bold text-lg mb-4">Edit Webhook</h3>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Webhook URL</span>
                        </label>
                        <input id="editWebhookUrl" type="url" value="${webhook.url}" class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Event Type</span>
                        </label>
                        <select id="editWebhookEventType" class="select select-bordered">
                            <option value="all" ${webhook.eventType === 'all' ? 'selected' : ''}>All Events</option>
                            <option value="progress" ${webhook.eventType === 'progress' ? 'selected' : ''}>Progress Updates</option>
                            <option value="completed" ${webhook.eventType === 'completed' ? 'selected' : ''}>Job Completion</option>
                            <option value="failed" ${webhook.eventType === 'failed' ? 'selected' : ''}>Job Failures</option>
                        </select>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Description</span>
                        </label>
                        <input id="editWebhookDescription" type="text" value="${webhook.description || ''}" class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="cursor-pointer label">
                            <span class="label-text">Active</span>
                            <input id="editWebhookActive" type="checkbox" ${webhook.active ? 'checked' : ''} class="checkbox" />
                        </label>
                    </div>
                    
                    <div class="modal-action">
                        <button class="btn" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="updateWebhook(${webhookId})">Update</button>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="this.closest('.modal').remove()"></div>
            `;
            
            document.body.appendChild(modal);
        }

        async function updateWebhook(webhookId) {
            const url = document.getElementById('editWebhookUrl').value;
            const eventType = document.getElementById('editWebhookEventType').value;
            const description = document.getElementById('editWebhookDescription').value;
            const active = document.getElementById('editWebhookActive').checked;

            try {
                const response = await fetch(`${API_BASE}/webhooks/${webhookId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ url, eventType, description, active })
                });

                if (response.ok) {
                    showNotification('Webhook updated successfully!', 'success');
                    document.querySelector('.modal').remove();
                    loadWebhooks();
                } else {
                    showNotification('Failed to update webhook', 'error');
                }
            } catch (error) {
                showNotification('Network error while updating webhook', 'error');
                console.error('Update webhook error:', error);
            }
        }

        // UI Helper Functions
        function showLogin() {
            hideAllSections();
            document.getElementById('loginSection').classList.remove('hidden');
        }

        function showRegister() {
            hideAllSections();
            document.getElementById('registerSection').classList.remove('hidden');
        }

        function showDashboard() {
            hideAllSections();
            document.getElementById('dashboardSection').classList.remove('hidden');
        }

        function showJobSubmission() {
            hideAllSections();
            document.getElementById('jobSubmissionSection').classList.remove('hidden');
        }

        function showWebhooks() {
            hideAllSections();
            document.getElementById('webhooksSection').classList.remove('hidden');
            loadWebhooks();
        }

        function hideAllSections() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('registerSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('jobSubmissionSection').classList.add('hidden');
            document.getElementById('webhooksSection').classList.add('hidden');
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (connected) {
                statusElement.className = 'w-3 h-3 rounded-full bg-success status-indicator';
                textElement.textContent = 'Connected';
            } else {
                statusElement.className = 'w-3 h-3 rounded-full bg-error';
                textElement.textContent = 'Disconnected';
            }
        }

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} notification`;
            
            const icon = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            }[type] || 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingModal').classList.add('modal-open');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.remove('modal-open');
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            setTheme(savedTheme);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'j':
                        e.preventDefault();
                        showJobSubmission();
                        break;
                    case 'd':
                        e.preventDefault();
                        showDashboard();
                        break;
                    case 'w':
                        e.preventDefault();
                        showWebhooks();
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshJobs();
                        break;
                }
            }
        });

        // Auto-refresh jobs every 30 seconds when on dashboard
        setInterval(() => {
            if (!document.getElementById('dashboardSection').classList.contains('hidden')) {
                refreshJobs();
            }
        }, 30000);
    </script>
</body>
</html>
